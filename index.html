<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>麻雀点数計算アプリ</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #ffffff; /* 白背景 */
            color: #333;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: auto;
            max-width: 600px;
            margin: auto;
            padding: 0;
            box-sizing: border-box;
            margin-bottom: 20px;
            margin-top: 20px;
        }

        h1 {
            margin-top: 0px;
            font-size: 2.5rem;
            color: #005bab; /* 濃い青 */
            text-align: center;
            margin-bottom: 1rem;
        }

        .player-container {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            width: 100%;
        }

        .player-label {
            width: 100px;
            font-size: 1.1rem;
            color: #333;
        }

        input {
            flex: 1;
            padding: 0.5rem;
            font-size: 1rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #aaa;
            border-radius: 5px;
            background-color: #f0f8ff; /* 薄い青 */
        }

        button {
            width: 48%;
            padding: 0.75rem;
            background: linear-gradient(45deg, #005bab, #00aaff); /* 青のグラデーション */
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 5px 1%;
            transition: background 0.3s ease;
        }

        button:hover {
            background: linear-gradient(45deg, #00aaff, #005bab); /* ホバー時の色 */
        }

        .error-message {
            color: red;
            margin-top: 10px;
            font-size: 1.1rem;
        }

        .result-table {
            margin-top: 1rem;
            width: 92%;
            border-collapse: collapse;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .result-table th, .result-table td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: center;
        }

        .result-table th {
            background-color: #005bab; /* テーブルヘッダーを青に */
            color: white;
        }

        .result-score {
            margin-top: 1rem;
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            color: #005bab;
        }

        .total-score, .average-rank {
            margin-top: 1rem;
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            color: #005bab;
        }

        form {
            max-width: 400px;
            width: 92%;
            padding: 1.8rem;
            background-color: #f5f5f5; /* 薄いグレー */
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2rem;
            }
            .result-table {
                font-size: 0.8rem; /* モバイル時はさらに小さくする */
                width: 100%; /* モバイルで画面にフィットさせる */
            }

            button {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- ここからがサイトの内容 -->
    <form>
        <h1>麻雀点数計算アプリ</h1>
        <!-- 点数入力部分 -->
        <div class="player-container">
            <label class="player-label" id="playerLabel1">player1</label> <!-- url から入力される-->
            <input type="text" id="player1" placeholder="点数を入力">
        </div>
        <div class="player-container">
            <label class="player-label" id="playerLabel2">player2</label>
            <input type="text" id="player2" placeholder="点数を入力">
        </div>
        <div class="player-container">
            <label class="player-label" id="playerLabel3">player3</label>
            <input type="text" id="player3" placeholder="点数を入力">
        </div>
        <div class="player-container">
            <label class="player-label" id="playerLabel4">player4</label>
            <input type="text" id="player4" placeholder="点数を入力">
        </div>

        <!-- ボタン機能部分 -->
        <button type="button" onclick="add_scores()">計算して追加</button>
        <button type="button" onclick="confirmDelete()">最新の1行を削除</button>
        <button type="button" onclick="resetPage()">ページをリセット</button>

        <div class="error-message" id="errorMessage"></div>

    </form>

    <!-- 点数表示部分 -->
    <div class="result-score" id="resultScoreText">点数表</div>
    <table class="result-table" id="resultTable">
        <thead>
            <tr id="playerNames">
                <th colspan="2">player1</th>
                <th colspan="2">player2</th>
                <th colspan="2">player3</th>
                <th colspan="2">player4</th>
            </tr>
            <tr id="rank_pt">
                <th>順位</th>
                <th>pt</th>
                <th>順位</th>
                <th>pt</th>
                <th>順位</th>
                <th>pt</th>
                <th>順位</th>
                <th>pt</th>
            </tr>
        </thead>
        <tbody>
            <!-- 結果がここに追加されていく -->
        </tbody>
    </table>

    <div class="total-score" id="totalScoreText">合計pt</div>
    <table class="result-table" id="totalScoreTable">
        <thead>
            <tr id="playerNames2">
                <th>player1</th>
                <th>player2</th>
                <th>player3</th>
                <th>player4</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td id="totalScore1">0</td>
                <td id="totalScore2">0</td>
                <td id="totalScore3">0</td>
                <td id="totalScore4">0</td>
            </tr>
        </tbody>
    </table>

    <div class="average-rank" id="averageRankText">平均順位</div>
    <table class="result-table" id="averageRankTable">
        <thead>
            <tr id="playerNames3">
                <th>player1</th>
                <th>player2</th>
                <th>player3</th>
                <th>player4</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td id="average_rank1">-</td>
                <td id="average_rank2">-</td>
                <td id="average_rank3">-</td>
                <td id="average_rank4">-</td>
            </tr>
        </tbody>
    </table>

    <!-- 以下javascriptコード -->
    <script>
        function setPlayerNames() {
            let player1 = localStorage.getItem('player1') || prompt("Player 1 の名前を入力してください:");
            let player2 = localStorage.getItem('player2') || prompt("Player 2 の名前を入力してください:");
            let player3 = localStorage.getItem('player3') || prompt("Player 3 の名前を入力してください:");
            let player4 = localStorage.getItem('player4') || prompt("Player 4 の名前を入力してください:");

            // 名前をラベルに反映
            document.getElementById('playerLabel1').textContent = player1;
            document.getElementById('playerLabel2').textContent = player2;
            document.getElementById('playerLabel3').textContent = player3;
            document.getElementById('playerLabel4').textContent = player4;

            // 名前をテーブルヘッダーにも反映
            document.getElementById('playerNames').children[0].textContent = player1;
            document.getElementById('playerNames').children[1].textContent = player2;
            document.getElementById('playerNames').children[2].textContent = player3;
            document.getElementById('playerNames').children[3].textContent = player4;
            
            document.getElementById('playerNames2').children[0].textContent = player1;
            document.getElementById('playerNames2').children[1].textContent = player2;
            document.getElementById('playerNames2').children[2].textContent = player3;
            document.getElementById('playerNames2').children[3].textContent = player4;
            
            document.getElementById('playerNames3').children[0].textContent = player1;
            document.getElementById('playerNames3').children[1].textContent = player2;
            document.getElementById('playerNames3').children[2].textContent = player3;
            document.getElementById('playerNames3').children[3].textContent = player4;

            // localStorage に名前を保存
            localStorage.setItem('player1', player1);
            localStorage.setItem('player2', player2);
            localStorage.setItem('player3', player3);
            localStorage.setItem('player4', player4);
        }


        function saveDataToLocalStorage() {
            const resultTable = document.getElementById('resultTable').innerHTML;
            const totalScoreTable = document.getElementById('totalScoreTable').innerHTML;
            const averageRankTable = document.getElementById('averageRankTable').innerHTML;

            // テーブルのHTMLをlocalStorageに保存
            localStorage.setItem('resultTable', resultTable);
            localStorage.setItem('totalScoreTable', totalScoreTable);
            localStorage.setItem('averageRankTable', averageRankTable);
        }

        function loadDataFromLocalStorage() {
            const savedResultTable = localStorage.getItem('resultTable');
            const savedTotalScoreTable = localStorage.getItem('totalScoreTable');
            const savedAverageRankTable = localStorage.getItem('averageRankTable');

            if (savedResultTable) {
                document.getElementById('resultTable').innerHTML = savedResultTable;
            }
            if (savedTotalScoreTable) {
                document.getElementById('totalScoreTable').innerHTML = savedTotalScoreTable;
            }
            if (savedAverageRankTable) {
                document.getElementById('averageRankTable').innerHTML = savedAverageRankTable;
            }
        }

        function resetPage() {
            if (confirm("ページをリセットすると、すべてのデータが削除されます。よろしいですか？")) {
                localStorage.clear();  // ローカルストレージをすべてクリア
                location.reload();     // ページをリロード
            }
        }


        function sort_scores(scores) {
            // 同じスコアのプレイヤーがいるかを調べる
            let hasSameScore = false;
            for (let i = 0; i < scores.length; i++) {
                for (let j = i + 1; j < scores.length; j++) {
                    if (scores[i].score === scores[j].score) {
                        hasSameScore = true;
                        break;
                    }
                }
                if (hasSameScore) {
                    break;
                }
            }

            // 同じスコアのプレイヤーがいた場合
            if (hasSameScore) {
                const order = [];
                let sum = 0;
                for (let i = 0; i < 4; i++) {
                    input = prompt(`${scores[i].name}の順位を半角数字で入力してください:`);
                    order.push(parseInt(input));
                    sum += parseInt(input);
                }
                for (let i = 0; i < 4; i++){
                    scores[i].rank = order[i];
                }
                scores.sort((a, b) => a.rank - b.rank);
                let error_flag = false;
                for (let i = 0; i < 4; i++){
                    for (let j = i+1; j < 4; j++){
                        if (scores[i].score < scores[j].score) {
                            error_flag = true;
                        }
                    }
                }
                if (error_flag || sum != 10) {
                    alert('正しい順位を入力してください');
                    return;
                }
                // for (let i = 0; i < 4; i++){
                //     delete scores[i].rank;
                // }
                return scores;

            // 同じスコアのプレイヤーがいなかった場合
            } else {
                scores.sort((a, b) => {
                    return b.score - a.score;
                });
                for (let i = 0; i < 4; i++){
                    scores[i].rank = i+1;
                }
                return scores;
            }
        }
    
        function cal_scores() {
            const baseScore = 25000;
            let player1 = parseInt(document.getElementById('player1').value) || 0;
            let player2 = parseInt(document.getElementById('player2').value) || 0;
            let player3 = parseInt(document.getElementById('player3').value) || 0;
            let player4 = parseInt(document.getElementById('player4').value) || 0;
    
            const totalScore = player1 + player2 + player3 + player4;
            if ((totalScore !== 100000)　&& (totalScore !== 1000)) {
                if (totalScore > 10000) {
                    document.getElementById('errorMessage').textContent = 'エラー: 合計点数が100,000点ではありません。';
                } else {
                    document.getElementById('errorMessage').textContent = 'エラー: 合計点数が1,000点ではありません。';
                }
                return;
            } 
            document.getElementById('errorMessage').textContent = ''; 
            
            // ウマオカの計算
            if (totalScore == 1000) { // 点数の合計が1000だったときの処理
                player1 *= 100
                player2 *= 100
                player3 *= 100
                player4 *= 100
            }
            let scores = [
                { score: player1, index: 1, name: document.getElementById('playerLabel1').textContent },
                { score: player2, index: 2, name: document.getElementById('playerLabel2').textContent },
                { score: player3, index: 3, name: document.getElementById('playerLabel3').textContent },
                { score: player4, index: 4, name: document.getElementById('playerLabel4').textContent }
            ];
            // ソートを実行
            scores = sort_scores(scores); // ここでオブジェクトにrankが追加される

            // ウマオカの計算
            scores[0].score += 30000; 
            scores[1].score += 10000; 
            scores[2].score -= 10000; 
            scores[3].score -= 30000;
            // スコアから金額へ これはテン5の計算式
            scores.forEach(score => {
                score.score = Math.floor((score.score - baseScore) / 20);
            });
            return scores;
        }
    
        function add_scores() {
            let scores = cal_scores()
    
            // 表への追加
            scores.sort((a, b) => a.index - b.index);
    
            const resultRow = document.createElement('tr'); // trはテーブルの行
            scores.forEach((score, idx) => {
                const resultCell1 = document.createElement('td'); // tdはテーブルのセル
                resultCell1.textContent = score.rank;
                resultRow.appendChild(resultCell1);

                const resultCell2 = document.createElement('td'); // tdはテーブルのセル
                resultCell2.textContent = score.score;
                resultRow.appendChild(resultCell2);
            });
    
            document.getElementById('resultTable').querySelector('tbody').appendChild(resultRow);

            updateTotalScores(); // 合計得点の更新
            updateAverageRank(); // 平均順位の表示

            // 現在のテーブルの情報をサーバに送る
            let score_list = [];
            for (let i = 0; i < 4; i++) {
                score_list.push(scores[i].score);
            }
            let rank_list = [];
            for (let i = 0; i < 4; i++) {
                rank_list.push(scores[i].rank);
            }

            saveDataToLocalStorage();  // スコアを追加した後にデータを保存
        }
    　
        function updateTotalScores() {
            let table = document.getElementById('resultTable');
            let total_score = [0, 0, 0, 0];

            for (let i=0; i < table.rows.length-2; i++) { // テーブルの行数分だけループ
                j = i*8 + 1;
                total_score[0] += parseInt(document.getElementsByTagName("td")[j].textContent);
                total_score[1] += parseInt(document.getElementsByTagName("td")[j+2].textContent);
                total_score[2] += parseInt(document.getElementsByTagName("td")[j+4].textContent);
                total_score[3] += parseInt(document.getElementsByTagName("td")[j+6].textContent);
            }
            document.getElementById('totalScore1').textContent = total_score[0];
            document.getElementById('totalScore2').textContent = total_score[1];
            document.getElementById('totalScore3').textContent = total_score[2];
            document.getElementById('totalScore4').textContent = total_score[3];
        }

        function updateAverageRank() {
            let table = document.getElementById('resultTable');
            let total_rank = [0, 0, 0, 0];

            for (let i=0; i < table.rows.length-2; i++) { // テーブルの行数分だけループ
                j = i*8;
                total_rank[0] += parseInt(document.getElementsByTagName("td")[j].textContent);
                total_rank[1] += parseInt(document.getElementsByTagName("td")[j+2].textContent);
                total_rank[2] += parseInt(document.getElementsByTagName("td")[j+4].textContent);
                total_rank[3] += parseInt(document.getElementsByTagName("td")[j+6].textContent);
            }
            document.getElementById('average_rank1').textContent = (total_rank[0] / (table.rows.length-2)).toFixed(2);
            document.getElementById('average_rank2').textContent = (total_rank[1] / (table.rows.length-2)).toFixed(2);
            document.getElementById('average_rank3').textContent = (total_rank[2] / (table.rows.length-2)).toFixed(2);
            document.getElementById('average_rank4').textContent = (total_rank[3] / (table.rows.length-2)).toFixed(2);
        }
    
        function confirmDelete() {
            const confirmDelete = confirm("最新の1行を削除しますか？");
            if (confirmDelete) {
                deleteLastRow();
            }
            // 現在のテーブルの情報をサーバに送る
        }
    
        function deleteLastRow() {
            const table = document.getElementById('resultTable');
            const rowCount = table.rows.length;
    
            if (rowCount > 2) {  
                table.deleteRow(rowCount-1);  
                updateTotalScores(); 
                updateAverageRank(); 
            }
        }

        window.onload = function() {
            setPlayerNames();  // ページ読み込み時にユーザ名を設定
            loadDataFromLocalStorage();  // ページ読み込み時にデータを復元
        };
    </script>

</body>
</html>
